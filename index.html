<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JENNIE Voice Assistant</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <canvas id="sphere-canvas"></canvas>
        <div class="content">
            <div class="header">
                <h1>Jennie</h1>
            </div>
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages will appear here -->
                </div>
            </div>
            <div class="controls">
                <button id="voice-btn" class="voice-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1v8m0 0v6m0-6h6m-6 0H6m6 12v3m-4 0h8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="script.js"></script>
    <script>
    const BACKEND_URL = "https://jennie-backend.onrender.com";

    const voiceCircle = document.getElementById('voiceCircle');
    const statusText = document.getElementById('statusText');
    const transcriptText = document.getElementById('transcriptText');
    const responseCard = document.getElementById('responseCard');
    const responseTitle = document.getElementById('responseTitle');
    const responseContent = document.getElementById('responseContent');

    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        speechSynthesis.speak(utterance);
      }
    }

    function showResponse(title, content) {
      responseTitle.textContent = title;
      responseContent.innerHTML = content;
      responseCard.classList.add('show');
    }

    async function wishUser() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/wish`);
        const data = await res.json();
        showResponse("Jennie:", data.response);
        speak(data.response);
      } catch (err) {
        console.error("Greeting fetch failed:", err);
      }
    }

    async function callBackend(query) {
      try {
        statusText.textContent = "Talking to Jennie backend...";
        const res = await fetch(`${BACKEND_URL}/api/command`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });
        const data = await res.json();
        return data;
      } catch {
        return { response: "Backend not reachable right now." };
      } finally {
        statusText.textContent = "Tap to Start Listening";
      }
    }

    // === Speech Recognition ===
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      statusText.textContent = 'Speech recognition not supported';
      throw new Error('SpeechRecognition not supported');
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.continuous = false;

    recognition.onresult = async (event) => {
      const transcript = event.results[0][0].transcript.trim();
      transcriptText.textContent = transcript;
      showResponse("You said:", transcript);

      // Handle Wikipedia
      if (transcript.toLowerCase().includes("wikipedia")) {
        const topic = transcript.replace(/search|on|in|open|wikipedia/gi, "").trim();
        if (topic) {
          const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(topic)}`;
          speak(`Opening ${topic} on Wikipedia`);
          showResponse("Jennie:", `Opening <b>${topic}</b> on Wikipedia...`);
          window.open(wikiUrl, "_blank");
          return;
        }
      }

      const data = await callBackend(transcript);
      showResponse("Jennie:", data.response);
      speak(data.response);

      // Handle actions
      const urls = {
        open_youtube: "https://www.youtube.com",
        open_google: "https://www.google.com",
        open_flipkart: "https://www.flipkart.com",
        open_amazon: "https://www.amazon.in",
        open_chatgpt: "https://www.chat.openai.com",
        open_spotify: "https://open.spotify.com"
      };
      if (data.action && urls[data.action]) {
        window.open(urls[data.action], "_blank");
      } else if (data.action === "search_google") {
        const encoded = encodeURIComponent(data.query || transcript);
        window.open(`https://www.google.com/search?q=${encoded}`, "_blank");
      }

      loadHistory();
    };

    voiceCircle.onclick = () => {
      recognition.start();
      statusText.textContent = "Listening...";
      responseCard.classList.remove('show');
    };

    recognition.onend = () => {
      statusText.textContent = "Tap to Start Listening";
    };

    // === Chat History ===
    async function loadHistory() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/last_queries`);
        const arr = await res.json();
        const html = arr.map(a => `<div>${new Date(a.time).toLocaleTimeString()}: ${a.query}</div>`).join("");
        let panel = document.getElementById("historyPanel");
        if (!panel) {
          panel = document.createElement("div");
          panel.id = "historyPanel";
          panel.style.position = "fixed";
          panel.style.left = "20px";
          panel.style.bottom = "20px";
          panel.style.background = "rgba(255,255,255,0.1)";
          panel.style.padding = "8px";
          panel.style.borderRadius = "8px";
          panel.style.maxWidth = "260px";
          panel.style.fontSize = "12px";
          panel.style.color = "#fff";
          document.body.appendChild(panel);
        }
        panel.innerHTML = `<strong>Recent:</strong><br/>${html}`;
      } catch (e) {
        console.error(e);
      }
    }

    // === Notifications / Reminders ===
    async function ensureNotificationPermission() {
      if ("Notification" in window && Notification.permission === "default") {
        await Notification.requestPermission();
      }
    }

    async function pollReminders() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/reminders/due`);
        const due = await res.json();
        for (const r of due) {
          if (Notification.permission === "granted") {
            new Notification("Jennie Reminder", { body: r.text });
          }
          speak(`Reminder: ${r.text}`);
        }
      } catch (e) {
        console.error("Poll error", e);
      }
    }

    // === Initialize ===
    window.onload = async () => {
      await wishUser();
      await loadHistory();
      await ensureNotificationPermission();
      pollReminders();
      setInterval(pollReminders, 60000);
    };

    // === Commands Modal ===
    const modal = document.getElementById("commandsModal");
    const btn = document.getElementById("commandsBtn");
    const closeBtn = document.getElementById("closeModal");
    btn.onclick = () => (modal.style.display = "flex");
    closeBtn.onclick = () => (modal.style.display = "none");
    window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
  </script>
</body>
</html>

